name: Copilot PR Automation

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: PR number to process
        required: true
        type: string
  pull_request_target:
    types: [opened, synchronize]

permissions:
  contents: write
  pull-requests: write
  issues: write
  statuses: write

jobs:
  copilot-automation:
    runs-on: ubuntu-latest
    steps:
      - name: Process Copilot PR
        uses: actions/github-script@v7
        with:
          script: |
            // Get PR info based on event type
            let prNumber, pr;

            if (context.eventName === 'workflow_dispatch') {
              prNumber = parseInt(context.payload.inputs.pr_number, 10);
            } else if (context.eventName === 'pull_request_target') {
              prNumber = context.payload.pull_request.number;
            }

            if (!prNumber) {
              core.info('No PR number found');
              return;
            }

            // Get PR details
            const { data: prData } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            pr = prData;

            // Check if Copilot PR
            const author = pr.user.login;
            const isCopilot = author === 'Copilot' ||
                              author.toLowerCase().includes('copilot') ||
                              author.includes('[bot]');

            if (!isCopilot) {
              core.info(`PR #${prNumber} author ${author} is not Copilot, skipping`);
              return;
            }

            core.info(`Processing Copilot PR #${prNumber}`);
            const headSha = pr.head.sha;

            // 1. Override DCO
            core.info('Setting DCO status to success...');
            try {
              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: headSha,
                state: 'success',
                context: 'dco',
                description: 'DCO waived for Copilot',
                target_url: 'https://github.com/kubestellar/console/blob/master/CONTRIBUTING.md'
              });
              core.info('DCO status set to success');
            } catch (e) {
              core.warning(`Failed to set DCO: ${e.message}`);
            }

            // 2. Fix DCO labels
            core.info('Fixing DCO labels...');
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                name: 'dco-signoff: no'
              });
            } catch (e) { /* ignore */ }

            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: ['dco-signoff: yes']
              });
            } catch (e) {
              core.warning(`Failed to add label: ${e.message}`);
            }

            // 3. Fix title if WIP
            let title = pr.title;
            if (title.includes('[WIP]')) {
              core.info('Fixing WIP title...');
              const newTitle = title.replace('[WIP] ', '').replace('[WIP]', '').trim();
              const finalTitle = newTitle.match(/^[^\w]/) ? newTitle : '\uD83D\uDC1B ' + newTitle;

              try {
                await github.rest.pulls.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  title: finalTitle
                });
                core.info(`Title updated to: ${finalTitle}`);
              } catch (e) {
                core.warning(`Failed to update title: ${e.message}`);
              }

              // Remove WIP label
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  name: 'do-not-merge/work-in-progress'
                });
              } catch (e) { /* ignore */ }
            }

            // 4. Mark ready for review if draft
            if (pr.draft) {
              core.info('Marking PR as ready for review...');
              try {
                await github.graphql(`
                  mutation($prId: ID!) {
                    markPullRequestReadyForReview(input: {pullRequestId: $prId}) {
                      pullRequest { id }
                    }
                  }
                `, { prId: pr.node_id });
                core.info('Marked as ready for review');
              } catch (e) {
                core.warning(`Failed to mark ready: ${e.message}`);
              }
            }

            core.info('Copilot PR automation complete');
